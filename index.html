<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Logic Circuit Simulator</title>
    <style>
        body { font-family: sans-serif; display: flex; margin: 0; height: 100vh; overflow: hidden; background: #f0f0f0; }
        #sidebar { width: 200px; background: #333; color: white; padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 10; }
        .component-template { 
            background: #444; border: 1px solid #666; padding: 10px; cursor: grab; text-align: center; border-radius: 4px; 
            user-select: none; transition: background 0.2s;
        }
        .component-template:hover { background: #555; }
        #canvas-container { flex-grow: 1; position: relative; overflow: hidden; background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 20px 20px; }
        .gate { 
            position: absolute; width: 80px; height: 50px; background: white; border: 2px solid #333; 
            border-radius: 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: move; z-index: 5;
        }
        .gate.active-on { box-shadow: 0 0 15px #ffeb3b; border-color: #fbc02d; }
        .terminal { 
            position: absolute; width: 12px; height: 12px; background: #888; border-radius: 50%; border: 1px solid #333; cursor: crosshair; 
        }
        .terminal:hover { background: #ff5722; }
        .in1 { left: -7px; top: 10px; }
        .in2 { left: -7px; top: 30px; }
        .out { right: -7px; top: 20px; }
        .single-in .in1 { top: 20px; }
        .single-in .in2 { display: none; }
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3>回路素子</h3>
    <div class="component-template" draggable="true" data-type="SWITCH">SWITCH (入力)</div>
    <div class="component-template" draggable="true" data-type="LIGHT">LIGHT (出力)</div>
    <hr>
    <div class="component-template" draggable="true" data-type="AND">AND</div>
    <div class="component-template" draggable="true" data-type="OR">OR</div>
    <div class="component-template" draggable="true" data-type="NOT">NOT</div>
    <div class="component-template" draggable="true" data-type="NAND">NAND</div>
    <div class="component-template" draggable="true" data-type="NOR">NOR</div>
    <div class="component-template" draggable="true" data-type="XOR">XOR</div>
    <div class="component-template" draggable="true" data-type="XNOR">XNOR</div>
    <p style="font-size: 11px; color: #aaa;">ダブルクリックで削除</p>
</div>

<div id="canvas-container">
    <svg id="connections-svg"></svg>
</div>

<script>
    const container = document.getElementById('canvas-container');
    const svg = document.getElementById('connections-svg');
    let components = [];
    let wires = [];
    let draggingObj = null;
    let activeWire = null;

    // --- ロジック計算 ---
    function updateLogic() {
        // 全リセット
        components.forEach(c => { if(c.type !== 'SWITCH') c.inputs = []; });

        // 5回ほど反復計算（フィードバック回路などの簡易安定化のため）
        for(let i=0; i<5; i++) {
            wires.forEach(w => {
                const from = components.find(c => c.id === w.fromId);
                const to = components.find(c => c.id === w.toId);
                if(from && to) {
                    to.inputs[w.toTerminal] = from.value;
                }
            });

            components.forEach(c => {
                const in1 = c.inputs[0] || 0;
                const in2 = c.inputs[1] || 0;
                switch(c.type) {
                    case 'AND':  c.value = in1 && in2; break;
                    case 'OR':   c.value = in1 || in2; break;
                    case 'NOT':  c.value = in1 ? 0 : 1; break;
                    case 'NAND': c.value = !(in1 && in2) ? 1 : 0; break;
                    case 'NOR':  c.value = !(in1 || in2) ? 1 : 0; break;
                    case 'XOR':  c.value = in1 ^ in2; break;
                    case 'XNOR': c.value = (in1 === in2) ? 1 : 0; break;
                    case 'LIGHT': c.value = in1; break;
                }
                const el = document.getElementById(c.id);
                if(c.type === 'LIGHT' || c.type === 'SWITCH') {
                    el.innerText = `${c.type}\n(${c.value})`;
                    c.value ? el.classList.add('active-on') : el.classList.remove('active-on');
                }
            });
        }
        drawWires();
    }

    // --- 描画系 ---
    function drawWires() {
        svg.innerHTML = '';
        wires.forEach(w => {
            const fromEl = document.getElementById(w.fromId).querySelector('.out');
            const toEl = document.getElementById(w.toId).querySelector('.' + w.toTerminal);
            const rect = container.getBoundingClientRect();
            const b1 = fromEl.getBoundingClientRect();
            const b2 = toEl.getBoundingClientRect();
            
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", b1.left - rect.left + 6);
            line.setAttribute("y1", b1.top - rect.top + 6);
            line.setAttribute("x2", b2.left - rect.left + 6);
            line.setAttribute("y2", b2.top - rect.top + 6);
            line.setAttribute("stroke", components.find(c=>c.id===w.fromId).value ? "#ff5722" : "#555");
            line.setAttribute("stroke-width", "3");
            svg.appendChild(line);
        });
    }

    // --- イベント管理 ---
    container.addEventListener('dragover', e => e.preventDefault());
    container.addEventListener('drop', e => {
        e.preventDefault();
        const type = e.dataTransfer.getData('type');
        const id = 'comp_' + Date.now();
        const x = e.clientX - 240;
        const y = e.clientY - 25;
        
        const comp = { id, type, x, y, value: 0, inputs: [0, 0] };
        components.push(comp);
        
        const el = document.createElement('div');
        el.id = id;
        el.className = `gate ${['NOT','LIGHT'].includes(type) ? 'single-in' : ''}`;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        el.innerText = type;
        
        if(type !== 'SWITCH') {
            const i1 = document.createElement('div'); i1.className = 'terminal in1'; el.appendChild(i1);
            const i2 = document.createElement('div'); i2.className = 'terminal in2'; el.appendChild(i2);
        }
        if(type !== 'LIGHT') {
            const out = document.createElement('div'); out.className = 'terminal out'; el.appendChild(out);
        }

        // 移動・操作イベント
        el.onmousedown = (e) => {
            if(e.target.classList.contains('terminal')) {
                activeWire = { fromId: id, fromX: e.clientX, fromY: e.clientY, terminal: e.target.classList[1] };
            } else {
                if(type === 'SWITCH') { comp.value = comp.value ? 0 : 1; updateLogic(); }
                draggingObj = comp;
            }
        };

        el.ondblclick = () => {
            components = components.filter(c => c.id !== id);
            wires = wires.filter(w => w.fromId !== id && w.toId !== id);
            el.remove();
            updateLogic();
        };

        container.appendChild(el);
        updateLogic();
    });

    document.querySelectorAll('.component-template').forEach(t => {
        t.ondragstart = e => e.dataTransfer.setData('type', t.dataset.type);
    });

    window.onmousemove = e => {
        if(draggingObj) {
            draggingObj.x += e.movementX;
            draggingObj.y += e.movementY;
            const el = document.getElementById(draggingObj.id);
            el.style.left = draggingObj.x + 'px';
            el.style.top = draggingObj.y + 'px';
            drawWires();
        }
    };

    window.onmouseup = e => {
        if(activeWire && e.target.classList.contains('terminal') && e.target.classList.contains('in1') || e.target.classList.contains('in2')) {
            const toId = e.target.parentElement.id;
            const toTerminal = e.target.classList.contains('in1') ? 'in1' : 'in2';
            // 既存の同じ入力への接続を上書き
            wires = wires.filter(w => !(w.toId === toId && w.toTerminal === toTerminal));
            wires.push({ fromId: activeWire.fromId, toId: toId, toTerminal: toTerminal });
            updateLogic();
        }
        draggingObj = null;
        activeWire = null;
    };
</script>

</body>
</html>
