<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>MIL Logic Simulator - Improved Delete</title>
    <style>
        body { font-family: sans-serif; display: flex; margin: 0; height: 100vh; overflow: hidden; background: #eef2f3; user-select: none; }
        #sidebar { width: 200px; background: #2c3e50; color: white; padding: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 10; }
        .component-template { background: #34495e; border: 1px solid #5d6d7e; padding: 10px; cursor: grab; text-align: center; border-radius: 4px; font-weight: bold; font-size: 13px; }
        .component-template:hover { background: #1abc9c; }
        #canvas-container { flex-grow: 1; position: relative; background: #fff; background-image: radial-gradient(#d1d1d1 1px, transparent 1px); background-size: 20px 20px; }
        
        .gate { 
            position: absolute; width: 80px; height: 50px; background: white; border: 2px solid #333; 
            display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: move; z-index: 5; border-radius: 4px; text-align: center;
        }
        .gate.active-on { border-color: #f1c40f; background: #fffde7; box-shadow: 0 0 15px rgba(241, 196, 15, 0.5); }
        .gate-label { pointer-events: none; font-size: 11px; white-space: pre; }

        .terminal { 
            position: absolute; width: 14px; height: 14px; background: #bdc3c7; border-radius: 50%; border: 2px solid #333; 
            cursor: pointer; z-index: 10;
        }
        .terminal:hover { background: #e74c3c; transform: scale(1.2); }
        .terminal.selected { background: #e74c3c; box-shadow: 0 0 10px #e74c3c; border-color: white; }
        
        .in1 { left: -10px; top: 8px; }
        .in2 { left: -10px; top: 28px; }
        .out { right: -10px; top: 18px; }
        .single-in .in1 { top: 18px; }
        
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 style="margin:0 0 10px 0">回路パーツ</h3>
    <div class="component-template" draggable="true" data-type="SWITCH">SWITCH</div>
    <div class="component-template" draggable="true" data-type="LIGHT">LIGHT</div>
    <hr style="width:100%; border:0; border-top:1px solid #5d6d7e">
    <div class="component-template" draggable="true" data-type="AND">AND</div>
    <div class="component-template" draggable="true" data-type="OR">OR</div>
    <div class="component-template" draggable="true" data-type="NOT">NOT</div>
    <div class="component-template" draggable="true" data-type="NAND">NAND</div>
    <div class="component-template" draggable="true" data-type="NOR">NOR</div>
    <div class="component-template" draggable="true" data-type="XOR">XOR</div>
    <div class="component-template" draggable="true" data-type="XNOR">XNOR</div>
    <p style="font-size: 10px; color: #ccc; margin-top:20px;">※1秒以内に2回クリックで削除</p>
</div>

<div id="canvas-container"><svg id="connections-svg"></svg></div>

<script>
    const container = document.getElementById('canvas-container');
    const svg = document.getElementById('connections-svg');
    let components = [];
    let wires = [];
    let draggingObj = null;
    let selectedTerminal = null;

    function updateLogic() {
        components.forEach(c => { if(c.type !== 'SWITCH') c.inputs = { in1: 0, in2: 0 }; });
        for(let i = 0; i < 5; i++) {
            wires.forEach(w => {
                const src = components.find(c => c.id === w.fromId);
                const tgt = components.find(c => c.id === w.toId);
                if(src && tgt) tgt.inputs[w.toTerm] = src.value;
            });
            components.forEach(c => {
                const i1 = c.inputs?.in1 || 0; const i2 = c.inputs?.in2 || 0;
                if(c.type === 'AND') c.value = i1 && i2;
                else if(c.type === 'OR') c.value = i1 || i2;
                else if(c.type === 'NOT') c.value = i1 ? 0 : 1;
                else if(c.type === 'NAND') c.value = (i1 && i2) ? 0 : 1;
                else if(c.type === 'NOR') c.value = (i1 || i2) ? 0 : 1;
                else if(c.type === 'XOR') c.value = i1 ^ i2;
                else if(c.type === 'XNOR') c.value = i1 === i2 ? 1 : 0;
                else if(c.type === 'LIGHT') c.value = i1;
                
                const el = document.getElementById(c.id);
                if(el) {
                    const label = el.querySelector('.gate-label');
                    label.innerText = (c.type==='SWITCH'||c.type==='LIGHT') ? `${c.type}\n(${c.value})` : c.type;
                    c.value ? el.classList.add('active-on') : el.classList.remove('active-on');
                }
            });
        }
        drawWires();
    }

    function drawWires() {
        svg.innerHTML = '';
        const cr = container.getBoundingClientRect();
        wires.forEach(w => {
            const fEl = document.getElementById(w.fromId)?.querySelector('.out');
            const tEl = document.getElementById(w.toId)?.querySelector('.' + w.toTerm);
            if(!fEl || !tEl) return;
            const r1 = fEl.getBoundingClientRect(); const r2 = tEl.getBoundingClientRect();
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", r1.left - cr.left + 7); line.setAttribute("y1", r1.top - cr.top + 7);
            line.setAttribute("x2", r2.left - cr.left + 7); line.setAttribute("y2", r2.top - cr.top + 7);
            line.setAttribute("stroke", components.find(c=>c.id===w.fromId).value ? "#f39c12" : "#333");
            line.setAttribute("stroke-width", "3");
            svg.appendChild(line);
        });
    }

    container.ondragover = e => e.preventDefault();
    container.ondrop = e => {
        e.preventDefault();
        const type = e.dataTransfer.getData('type');
        if(!type) return;
        const id = 'c' + Date.now();
        const rect = container.getBoundingClientRect();
        const comp = { id, type, x: e.clientX - rect.left - 40, y: e.clientY - rect.top - 25, value: 0, lastClick: 0 };
        components.push(comp);
        
        const el = document.createElement('div');
        el.id = id; 
        el.className = `gate ${['NOT','LIGHT'].includes(type) ? 'single-in' : ''}`;
        el.style.left = comp.x + 'px'; el.style.top = comp.y + 'px';

        const label = document.createElement('span');
        label.className = 'gate-label';
        el.appendChild(label);

        if (type !== 'SWITCH') {
            const names = (type === 'NOT' || type === 'LIGHT') ? ['in1'] : ['in1', 'in2'];
            names.forEach(n => {
                const t = document.createElement('div'); t.className = `terminal ${n}`;
                t.onclick = (ev) => { ev.stopPropagation(); connect(id, n, t); };
                el.appendChild(t);
            });
        }
        if (type !== 'LIGHT') {
            const t = document.createElement('div'); t.className = `terminal out`;
            t.onclick = (ev) => { ev.stopPropagation(); connect(id, 'out', t); };
            el.appendChild(t);
        }

        // クリック判定とドラッグ開始
        el.onmousedown = (e) => {
            if(e.target.classList.contains('terminal')) return;
            
            const now = Date.now();
            // --- 削除判定: 前回のクリックから1秒以内か ---
            if (now - comp.lastClick < 1000) {
                components = components.filter(c => c.id !== id);
                wires = wires.filter(w => w.fromId !== id && w.toId !== id);
                el.remove();
                updateLogic();
                draggingObj = null;
                return;
            }
            comp.lastClick = now;

            if(type === 'SWITCH') { 
                comp.value = comp.value ? 0 : 1; 
                updateLogic(); 
            }
            draggingObj = comp;
        };

        container.appendChild(el);
        updateLogic();
    };

    function connect(compId, termName, el) {
        if (!selectedTerminal) {
            selectedTerminal = { id: compId, term: termName, el: el };
            el.classList.add('selected');
        } else {
            const t1 = selectedTerminal;
            const isOut1 = t1.term === 'out';
            const isOut2 = termName === 'out';
            if (isOut1 !== isOut2 && t1.id !== compId) {
                const outId = isOut1 ? t1.id : compId;
                const inId = isOut1 ? compId : t1.id;
                const inTerm = isOut1 ? termName : t1.term;
                wires = wires.filter(w => !(w.toId === inId && w.toTerm === inTerm));
                wires.push({ fromId: outId, toId: inId, toTerm: inTerm });
            }
            selectedTerminal.el.classList.remove('selected');
            selectedTerminal = null;
            updateLogic();
        }
    }

    document.querySelectorAll('.component-template').forEach(t => {
        t.ondragstart = e => e.dataTransfer.setData('type', t.dataset.type);
    });

    window.onmousemove = e => {
        if(draggingObj) {
            draggingObj.x += e.movementX; draggingObj.y += e.movementY;
            const el = document.getElementById(draggingObj.id);
            if(el) {
                el.style.left = draggingObj.x + 'px'; el.style.top = draggingObj.y + 'px';
                drawWires();
            }
        }
    };
    window.onmouseup = () => { draggingObj = null; };
</script>
</body>
</html>
